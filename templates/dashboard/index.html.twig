{% extends 'base.html.twig' %}

{% block title %}Dashboard - Health Spring{% endblock %}

{% block body %}
<div class="container my-4">
    {# Header Stats #}
    <div class="row mb-4 so-dashboard-metrics g-3 g-md-4">
        <div class="col-12 col-md-4">
            <div class="card so-metric-card">
                <div class="card-body">
                    <div class="so-metric-label">Total score</div>
                    <div class="so-metric-value">{{ totalScore }}</div>
                    <div class="so-metric-pill so-metric-pill--total">All time</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card so-metric-card">
                <div class="card-body">
                    <div class="so-metric-label">Current week</div>
                    <div class="so-metric-value">{{ currentWeekScore }}</div>
                    <div class="so-metric-pill so-metric-pill--week">This week</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card so-metric-card">
                <div class="card-body">
                    <div class="so-metric-label">Today</div>
                    <div class="so-metric-value">{{ todayScore }}</div>
                    <div class="so-metric-pill so-metric-pill--today">Today’s points</div>
                </div>
            </div>
        </div>
    </div>

    {# Weekly Tracker Section #}
    <div class="row mb-4 g-3 g-lg-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="mb-0">Weekly Tracker</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Once you mark a weekly task as done, it stays done.
                        You can come back later to add the other task, but you can’t untick what you’ve already completed.
                    </p>
                    <form id="weekly-log-form"
                          method="post"
                          action="{{ path('app_dashboard_weekly_log') }}"
                          data-is-admin="{{ is_granted('ROLE_ADMIN') ? '1' : '0' }}">
                        <div class="form-check mb-2">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="activity_done"
                                   id="activity_done"
                                   value="1"
                                   {{ currentWeekLog.activityDone ? 'checked' : '' }}
                                   data-initial="{{ currentWeekLog.activityDone ? '1' : '0' }}">
                            <label class="form-check-label fw-semibold" for="activity_done">
                                150 min Activity
                            </label>
                        </div>
                        <div class="text-muted small mb-3 ms-4">
                            Tick this when you’ve reached 150 minutes of movement this week.
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="social_done"
                                   id="social_done"
                                   value="1"
                                   {{ currentWeekLog.socialDone ? 'checked' : '' }}
                                   data-initial="{{ currentWeekLog.socialDone ? '1' : '0' }}">
                            <label class="form-check-label fw-semibold" for="social_done">
                                4 Social Interactions
                            </label>
                        </div>
                        <div class="text-muted small mb-3 ms-4">
                            Tick this when you’ve had at least four meaningful check‑ins this week.
                        </div>

                        <button type="submit" class="btn btn-super-action">Save this week</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="mb-0">Past Weeks</h4>
                </div>
                <div class="card-body">
                    {% if weeklyHistory is empty %}
                        <p class="text-muted small mb-0">
                            Your weekly tracker history will appear here once you’ve completed at least one week.
                        </p>
                    {% else %}
                        <p class="text-muted small">
                            A read‑only overview of your recent weeks in this challenge.
                        </p>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                <tr>
                                    <th scope="col">Week</th>
                                    <th scope="col" class="text-center">150 min Activity</th>
                                    <th scope="col" class="text-center">4 Social Interactions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in weeklyHistory %}
                                    {% set week = item.log %}
                                    <tr>
                                        <td>
                                            <span class="fw-semibold">
                                                Week {{ item.number }} ({{ item.start|date('d M') }} – {{ item.end|date('d M') }})
                                            </span>
                                            <span class="text-muted small d-block">
                                                Starts {{ item.start|date('d M Y') }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if week.activityDone %}
                                                <span class="badge bg-success rounded-pill">Done</span>
                                            {% else %}
                                                <span class="badge bg-light text-muted rounded-pill">Not done</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if week.socialDone %}
                                                <span class="badge bg-success rounded-pill">Done</span>
                                            {% else %}
                                                <span class="badge bg-light text-muted rounded-pill">Not done</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Calendar Section - single active month with navigation #}
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">Challenge Calendar</h4>
                </div>
                <div class="btn-group btn-group-sm">
                    {% if prevMonth %}
                        <a href="{{ path('app_dashboard', { month: prevMonth.key }) }}"
                           class="btn btn-outline-primary">
                            ‹ {{ prevMonth.name }}
                        </a>
                    {% endif %}
                    {% if nextMonth %}
                        <a href="{{ path('app_dashboard', { month: nextMonth.key }) }}"
                           class="btn btn-outline-primary">
                            {{ nextMonth.name }} ›
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body">
            {% set monthData = selectedMonth %}
            <div class="so-calendar-month">
                <h5 class="mb-3 text-center">{{ monthData.name }} {{ monthData.year }}</h5>
                {% set firstDay = date(monthData.year ~ '-' ~ monthData.month ~ '-01') %}
                {% set lastDay = firstDay|date_modify('last day of this month') %}
                {% set startDate = challengeService.startDateProperty %}
                {% set endDate = challengeService.endDateProperty %}

                {% set todayKey = 'now'|date('Y-m-d') %}
                {% set yesterdayKey = 'now'|date_modify('-1 day')|date('Y-m-d') %}

                <table class="table table-bordered calendar-table mb-0">
                        <thead>
                            <tr>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                                <th>Sun</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Twig has no "while": compute a fixed week grid and loop #}
                            {% set gridStart = firstDay|date_modify('monday this week') %}
                            {% set gridEnd = lastDay|date_modify('sunday this week') %}
                            {% set totalDays = ((gridEnd|date('U') - gridStart|date('U')) / 86400)|round(0, 'ceil') + 1 %}
                            {% set weeks = (totalDays / 7)|round(0, 'ceil') %}
                            {% set weeks = weeks < 1 ? 1 : weeks %}
                            {% set gridStartStr = gridStart|date('Y-m-d') %}

                            {% for w in 0..(weeks - 1) %}
                                <tr>
                                    {% for day in 0..6 %}
                                        {% set offsetDays = (w * 7) + day %}
                                        {% set dayDate = date(gridStartStr)|date_modify('+' ~ offsetDays ~ ' days') %}
                                        {% set dayKey = dayDate|date('Y-m-d') %}
                                        {% set isInMonth = dayDate|date('n') == monthData.month %}
                                        {% set isInChallenge = dayDate >= startDate and dayDate <= endDate %}
                                        
                                        {% if isInMonth and isInChallenge %}
                                            {% set log = dailyLogsMap[dayKey] ?? null %}
                                            {% if log %}
                                                {% set points = log.points %}
                                                {% if points == 4 %}
                                                    {% set cellClass = 'calendar-full' %}
                                                {% elseif points == 3 %}
                                                    {% set cellClass = 'calendar-high' %}
                                                {% elseif points >= 1 %}
                                                    {% set cellClass = 'calendar-mid' %}
                                                {% else %}
                                                    {% set cellClass = 'calendar-empty' %}
                                                {% endif %}
                                            {% else %}
                                                {% set points = 0 %}
                                                {% if dayKey < todayKey %}
                                                    {% set cellClass = 'calendar-missed' %}
                                                {% else %}
                                                    {% set cellClass = 'calendar-empty' %}
                                                {% endif %}
                                            {% endif %}

                                            {% set isEditable = (dayKey == yesterdayKey) %}

                                            <td class="{{ cellClass }} {{ isEditable ? 'calendar-day' : '' }}"
                                                {% if isEditable %}data-date="{{ dayKey }}"{% endif %}
                                                style="{{ isEditable ? 'cursor: pointer;' : '' }} min-width: 80px; height: 60px; vertical-align: middle; text-align: center;">
                                                <div>{{ dayDate|date('j') }}</div>
                                                <small>{{ points }}/4</small>
                                            </td>
                                        {% elseif isInMonth %}
                                            <td class="text-muted" style="min-width: 80px; height: 60px; vertical-align: middle; text-align: center;">
                                                {{ dayDate|date('j') }}
                                            </td>
                                        {% else %}
                                            <td style="min-width: 80px; height: 60px;"></td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Legend #}
<div class="container mb-4">
    <div class="card">
        <div class="card-body">
            <h6 class="mb-3">Legend</h6>
            <div class="d-flex flex-wrap gap-3">
                <div class="d-flex align-items-center">
                    <span class="legend-swatch calendar-full me-2"></span>
                    <small class="text-muted">4 tasks done</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="legend-swatch calendar-high me-2"></span>
                    <small class="text-muted">3 tasks done</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="legend-swatch calendar-mid me-2"></span>
                    <small class="text-muted">1–2 tasks done</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="legend-swatch calendar-missed me-2"></span>
                    <small class="text-muted">Missed day (past, 0 tasks)</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="legend-swatch calendar-empty me-2"></span>
                    <small class="text-muted">No data yet / future</small>
                </div>
            </div>
        </div>
</div>
</div>

{# Weekly tracker modals #}
<div class="modal fade" id="weeklyLockModal" tabindex="-1" aria-labelledby="weeklyLockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weeklyLockModalLabel">Weekly tracker locked</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                You can add weekly tasks, but you can’t uncheck something you have already completed.
                If this is a mistake, please ask an admin to update it for you.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="weeklyConfirmModal" tabindex="-1" aria-labelledby="weeklyConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weeklyConfirmModalLabel">Save this week?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="weeklyConfirmModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-super-action" id="weeklyConfirmModalConfirm">Save week</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.calendar-day').forEach(function(cell) {
        cell.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            window.location.href = '{{ path('app_dashboard_log_date', {'date': 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', date);
        });
    });

    const weeklyForm = document.getElementById('weekly-log-form');
    if (weeklyForm) {
        const isAdmin = weeklyForm.dataset.isAdmin === '1';
        const activityCb = document.getElementById('activity_done');
        const socialCb = document.getElementById('social_done');

        const lockModalEl = document.getElementById('weeklyLockModal');
        const confirmModalEl = document.getElementById('weeklyConfirmModal');
        const confirmModalBody = document.getElementById('weeklyConfirmModalBody');
        const confirmModalConfirmBtn = document.getElementById('weeklyConfirmModalConfirm');

        const lockModal = lockModalEl && window.bootstrap ? new bootstrap.Modal(lockModalEl) : null;
        const confirmModal = confirmModalEl && window.bootstrap ? new bootstrap.Modal(confirmModalEl) : null;

        function attachLockBehavior(cb) {
            if (!cb || isAdmin || !lockModal) return;
            const initial = cb.dataset.initial === '1';
            cb.addEventListener('change', function () {
                if (initial && !cb.checked) {
                    cb.checked = true;
                    lockModal.show();
                }
            });
        }

        attachLockBehavior(activityCb);
        attachLockBehavior(socialCb);

        const revertState = { activity: false, social: false };

        if (confirmModal && confirmModalBody && confirmModalConfirmBtn) {
            // When user confirms in the modal, mark as confirmed and submit
            confirmModalConfirmBtn.addEventListener('click', function () {
                confirmModalConfirmBtn.dataset.confirmed = '1';
                confirmModal.hide();
                weeklyForm.submit();
            });

            // When modal closes without confirmation, revert checkboxes to initial state
            confirmModalEl.addEventListener('hidden.bs.modal', function () {
                if (confirmModalConfirmBtn.dataset.confirmed !== '1') {
                    const initialActivity = activityCb ? activityCb.dataset.initial === '1' : false;
                    const initialSocial = socialCb ? socialCb.dataset.initial === '1' : false;

                    if (revertState.activity && activityCb) {
                        activityCb.checked = initialActivity;
                    }
                    if (revertState.social && socialCb) {
                        socialCb.checked = initialSocial;
                    }
                }

                // reset state
                confirmModalConfirmBtn.dataset.confirmed = '';
                revertState.activity = false;
                revertState.social = false;
            });
        }

        weeklyForm.addEventListener('submit', function (e) {
            if (isAdmin || !confirmModal || !confirmModalBody || !confirmModalConfirmBtn) {
                return; // admins can save directly or if modal is unavailable
            }

            const initialActivity = activityCb ? activityCb.dataset.initial === '1' : false;
            const initialSocial = socialCb ? socialCb.dataset.initial === '1' : false;
            const newActivity = activityCb ? activityCb.checked : false;
            const newSocial = socialCb ? socialCb.checked : false;

            const becameActivityDone = !initialActivity && newActivity;
            const becameSocialDone = !initialSocial && newSocial;

            if (!becameActivityDone && !becameSocialDone) {
                return; // nothing new, just save silently
            }

            e.preventDefault();

            // we only want to revert newly-checked boxes if user cancels
            revertState.activity = becameActivityDone;
            revertState.social = becameSocialDone;

            let html = '<p>You are about to save this week as:</p><ul>';
            if (newActivity) {
                html += '<li><strong>150 min Activity</strong>: done</li>';
            }
            if (newSocial) {
                html += '<li><strong>4 Social Interactions</strong>: done</li>';
            }
            html += '</ul><p class="mb-0">This cannot be undone later (you can only add more). Do you want to continue?</p>';

            confirmModalBody.innerHTML = html;
            confirmModal.show();
        });
    }
});
</script>

<style>
.calendar-table {
    width: 100%;
}
.calendar-day:hover {
    opacity: 0.8;
    transform: scale(1.05);
    transition: all 0.2s;
}
</style>
{% endblock %}
